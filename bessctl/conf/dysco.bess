import os
import scapy.all as scapy

os.system('ip netns del h1 > /dev/null')
os.system('ip netns del h2 > /dev/null')
os.system('ip netns del h3 > /dev/null')
os.system('ip netns del h4 > /dev/null')
os.system('ip netns add h1 > /dev/null')
os.system('ip netns add h2 > /dev/null')
os.system('ip netns add h3 > /dev/null')
os.system('ip netns add h4 > /dev/null')
os.system('echo 1 > /proc/sys/net/ipv4/ip_forward')

h1::DyscoVPort(ifname='h1-0', netns='/var/run/netns/h1',
			 mac_addr='00:00:00:00:00:11', ip_addrs=['10.0.1.1/24'])
h2_0::DyscoVPort(ifname='h2-0', netns='/var/run/netns/h2',
			 mac_addr='00:00:00:00:00:12', ip_addrs=['10.0.1.2/24'])
h2_1::DyscoVPort(ifname='h2-1', netns='/var/run/netns/h2',
			 mac_addr='00:00:00:00:00:22', ip_addrs=['10.0.2.2/24'])
h3_0::DyscoVPort(ifname='h3-0', netns='/var/run/netns/h3',
			 mac_addr='00:00:00:00:00:13', ip_addrs=['10.0.1.3/24']) 
h3_1::DyscoVPort(ifname='h3-1', netns='/var/run/netns/h3',
			 mac_addr='00:00:00:00:00:23', ip_addrs=['10.0.2.3/24'])
h4::DyscoVPort(ifname='h4-0', netns='/var/run/netns/h4',
			 mac_addr='00:00:00:00:00:14', ip_addrs=['10.0.1.4/24'])

os.system('ip netns exec h1 ifconfig lo up > /dev/null')
os.system('ip netns exec h2 ifconfig lo up > /dev/null')
os.system('ip netns exec h3 ifconfig lo up > /dev/null')
os.system('ip netns exec h4 ifconfig lo up > /dev/null')

os.system('ip netns exec h2 route add -host 10.0.1.4 gw 10.0.2.3 > /dev/null')
os.system('ip netns exec h3 route add -host 10.0.1.4 gw 10.0.2.2 > /dev/null')

os.system('ip netns exec h1 arp -s 10.0.1.2 00:00:00:00:00:12 > /dev/null')
os.system('ip netns exec h1 arp -s 10.0.1.3 00:00:00:00:00:13 > /dev/null')
os.system('ip netns exec h1 arp -s 10.0.1.4 00:00:00:00:00:14 > /dev/null')
os.system('ip netns exec h2 arp -s 10.0.1.1 00:00:00:00:00:11 > /dev/null')
os.system('ip netns exec h2 arp -s 10.0.1.3 00:00:00:00:00:13 > /dev/null')
os.system('ip netns exec h2 arp -s 10.0.1.4 00:00:00:00:00:14 > /dev/null')
os.system('ip netns exec h2 arp -s 10.0.2.3 00:00:00:00:00:23 > /dev/null')
os.system('ip netns exec h3 arp -s 10.0.1.1 00:00:00:00:00:11 > /dev/null')
os.system('ip netns exec h3 arp -s 10.0.1.2 00:00:00:00:00:12 > /dev/null')
os.system('ip netns exec h3 arp -s 10.0.1.4 00:00:00:00:00:14 > /dev/null')
os.system('ip netns exec h3 arp -s 10.0.2.2 00:00:00:00:00:22 > /dev/null')
os.system('ip netns exec h4 arp -s 10.0.1.1 00:00:00:00:00:11 > /dev/null')
os.system('ip netns exec h4 arp -s 10.0.1.2 00:00:00:00:00:12 > /dev/null')
os.system('ip netns exec h4 arp -s 10.0.1.3 00:00:00:00:00:13 > /dev/null')

ipl::IPLookup()
ipl.add(prefix='10.0.1.1', prefix_len=32, gate=0)
ipl.add(prefix='10.0.1.2', prefix_len=32, gate=1)
ipl.add(prefix='10.0.2.2', prefix_len=32, gate=2)
ipl.add(prefix='10.0.1.3', prefix_len=32, gate=3)
ipl.add(prefix='10.0.2.3', prefix_len=32, gate=4)
ipl.add(prefix='10.0.1.4', prefix_len=32, gate=5)

dc::DyscoCenter()

DyscoPortInc(port=h1) -> DyscoAgentOut(dc=dc) -> ipl
DyscoPortInc(port=h2_0) -> DyscoAgentOut(dc=dc) -> ipl
DyscoPortInc(port=h2_1) -> DyscoAgentOut(dc=dc) -> ipl
DyscoPortInc(port=h3_0) -> DyscoAgentOut(dc=dc) -> ipl
DyscoPortInc(port=h3_1) -> DyscoAgentOut(dc=dc) -> ipl
DyscoPortInc(port=h4) -> DyscoAgentOut(dc=dc) -> ipl

ipl:0 -> Update(fields=[{'offset':0, 'size':6, 'value':17}]) -> DyscoAgentIn(dc=dc) -> DyscoPortOut(port=h1)
ipl:1 -> Update(fields=[{'offset':0, 'size':6, 'value':18}]) -> DyscoAgentIn(dc=dc) -> DyscoPortOut(port=h2_0)
ipl:2 -> Update(fields=[{'offset':0, 'size':6, 'value':34}]) -> DyscoAgentIn(dc=dc) -> DyscoPortOut(port=h2_1)
ipl:3 -> Update(fields=[{'offset':0, 'size':6, 'value':19}]) -> DyscoAgentIn(dc=dc) -> DyscoPortOut(port=h3_0)
ipl:4 -> Update(fields=[{'offset':0, 'size':6, 'value':35}]) -> DyscoAgentIn(dc=dc) -> DyscoPortOut(port=h3_1)
ipl:5 -> Update(fields=[{'offset':0, 'size':6, 'value':20}]) -> DyscoAgentIn(dc=dc) -> DyscoPortOut(port=h4)

dc.add(priority=1, sc_len=2, chain=['10.0.1.2', '10.0.1.4'], filter='dst port 5001', ns='/var/run/netns/h1')
dc.add(priority=2, sc_len=2, chain=['10.0.1.3', '10.0.1.4'], filter='dst port 5002', ns='/var/run/netns/h1')
dc.add(priority=3, sc_len=3, chain=['10.0.1.2', '10.0.1.3', '10.0.1.4'], filter='dst port 5003', ns='/var/run/netns/h1')

os.system('ip netns exec h1 tcpdump -i h1-0 -n -XX -w /home/fabricio/h1.pcap & > /dev/null')
os.system('ip netns exec h2 tcpdump -i h2-0 -n -XX -w /home/fabricio/h2-0.pcap & > /dev/null')
os.system('ip netns exec h2 tcpdump -i h2-1 -n -XX -w /home/fabricio/h2-1.pcap & > /dev/null')
os.system('ip netns exec h3 tcpdump -i h3-0 -n -XX -w /home/fabricio/h3-0.pcap & > /dev/null')
os.system('ip netns exec h3 tcpdump -i h3-1 -n -XX -w /home/fabricio/h3-1.pcap & > /dev/null')
os.system('ip netns exec h4 tcpdump -i h4-0 -n -XX -w /home/fabricio/h4.pcap & > /dev/null')