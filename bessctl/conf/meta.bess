import os
import scapy.all as scapy

os.system('ip netns del h1 > /dev/null')
os.system('ip netns del h2 > /dev/null')
os.system('ip netns del h3 > /dev/null')
os.system('ip netns del h4 > /dev/null')
os.system('ip netns add h1 > /dev/null')
os.system('ip netns add h2 > /dev/null')
os.system('ip netns add h3 > /dev/null')
os.system('ip netns add h4 > /dev/null')
os.system('echo 1 > /proc/sys/net/ipv4/ip_forward')

h1::VPort(ifname='h1-0', netns='/var/run/netns/h1',
			 mac_addr='00:00:00:00:00:11', ip_addrs=['10.0.1.1/24'])
h2_0::VPort(ifname='h2-0', netns='/var/run/netns/h2',
			 mac_addr='00:00:00:00:00:12', ip_addrs=['10.0.1.2/24'])
h2_1::VPort(ifname='h2-1', netns='/var/run/netns/h2',
			 mac_addr='00:00:00:00:00:22', ip_addrs=['10.0.2.2/24'])
h3_0::VPort(ifname='h3-0', netns='/var/run/netns/h3',
			 mac_addr='00:00:00:00:00:13', ip_addrs=['10.0.1.3/24']) 
h3_1::VPort(ifname='h3-1', netns='/var/run/netns/h3',
			 mac_addr='00:00:00:00:00:23', ip_addrs=['10.0.2.3/24'])
h4::VPort(ifname='h4-0', netns='/var/run/netns/h4',
			 mac_addr='00:00:00:00:00:14', ip_addrs=['10.0.1.4/24'])

os.system('ip netns exec h1 ifconfig lo up > /dev/null')
os.system('ip netns exec h2 ifconfig lo up > /dev/null')
os.system('ip netns exec h3 ifconfig lo up > /dev/null')
os.system('ip netns exec h4 ifconfig lo up > /dev/null')

os.system('ip netns exec h2 route add -host 10.0.1.4 gw 10.0.2.3 > /dev/null')
os.system('ip netns exec h3 route add -host 10.0.1.4 gw 10.0.2.2 > /dev/null')

os.system('ip netns exec h1 arp -s 10.0.1.2 00:00:00:00:00:12 > /dev/null')
os.system('ip netns exec h1 arp -s 10.0.1.3 00:00:00:00:00:13 > /dev/null')
os.system('ip netns exec h1 arp -s 10.0.1.4 00:00:00:00:00:14 > /dev/null')
os.system('ip netns exec h2 arp -s 10.0.1.1 00:00:00:00:00:11 > /dev/null')
os.system('ip netns exec h2 arp -s 10.0.1.3 00:00:00:00:00:13 > /dev/null')
os.system('ip netns exec h2 arp -s 10.0.1.4 00:00:00:00:00:14 > /dev/null')
os.system('ip netns exec h2 arp -s 10.0.2.3 00:00:00:00:00:23 > /dev/null')
os.system('ip netns exec h3 arp -s 10.0.1.1 00:00:00:00:00:11 > /dev/null')
os.system('ip netns exec h3 arp -s 10.0.1.2 00:00:00:00:00:12 > /dev/null')
os.system('ip netns exec h3 arp -s 10.0.1.4 00:00:00:00:00:14 > /dev/null')
os.system('ip netns exec h3 arp -s 10.0.2.2 00:00:00:00:00:22 > /dev/null')
os.system('ip netns exec h4 arp -s 10.0.1.1 00:00:00:00:00:11 > /dev/null')
os.system('ip netns exec h4 arp -s 10.0.1.2 00:00:00:00:00:12 > /dev/null')
os.system('ip netns exec h4 arp -s 10.0.1.3 00:00:00:00:00:13 > /dev/null')

ipl::IPLookup()
ipl.add(prefix='10.0.1.1', prefix_len=32, gate=0)
ipl.add(prefix='10.0.1.2', prefix_len=32, gate=1)
ipl.add(prefix='10.0.2.2', prefix_len=32, gate=2)
ipl.add(prefix='10.0.1.3', prefix_len=32, gate=3)
ipl.add(prefix='10.0.2.3', prefix_len=32, gate=4)
ipl.add(prefix='10.0.1.4', prefix_len=32, gate=5)

dc::DyscoCenter()

PortInc(port=h1) -> DyscoAgentInc(port=h1, dc=dc) -> ipl
PortInc(port=h2_0) -> DyscoAgentInc(port=h2, dc=dc) -> ipl
PortInc(port=h2_1) -> DyscoAgentInc(port=h2, dc=dc) -> ipl
PortInc(port=h3_0) -> DyscoAgentInc(port=h3, dc=dc) -> ipl
PortInc(port=h3_1) -> DyscoAgentInc(port=h3, dc=dc) -> ipl
PortInc(port=h4) -> DyscoAgentInc(port=h4, dc=dc) -> ipl

ipl:0 -> DyscoAgentOut(port=h1, dc=dc) -> Update(fields=[{'offset':0, 'size':6, 'value':17}]) -> PortOut(port=h1)
ipl:1 -> DyscoAgentOut(port=h2, dc=dc) -> Update(fields=[{'offset':0, 'size':6, 'value':18}]) -> PortOut(port=h2_0)
ipl:2 -> DyscoAgentOut(port=h2, dc=dc) -> Update(fields=[{'offset':0, 'size':6, 'value':38}]) -> PortOut(port=h2_1)
ipl:3 -> DyscoAgentOut(port=h3, dc=dc) -> Update(fields=[{'offset':0, 'size':6, 'value':19}]) -> PortOut(port=h3_0)
ipl:4 -> DyscoAgentOut(port=h3, dc=dc) -> Update(fields=[{'offset':0, 'size':6, 'value':39}]) -> PortOut(port=h3_1)
ipl:5 -> DyscoAgentOut(port=h4, dc=dc) -> Update(fields=[{'offset':0, 'size':6, 'value':20}]) -> PortOut(port=h4)

dc.add(priority=1, sc_len=3, chain=['10.0.1.2', '10.0.1.3', '10.0.1.4'], filter='dst port 5001')