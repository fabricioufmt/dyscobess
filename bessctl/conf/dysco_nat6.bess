import os
import scapy.all as scapy

os.system('ip netns del R > /dev/null')
os.system('ip netns del LA > /dev/null')
os.system('ip netns del RA > /dev/null')
os.system('ip netns del c1 > /dev/null')
os.system('ip netns del m1 > /dev/null')
os.system('ip netns del m2 > /dev/null')
os.system('ip netns del s1 > /dev/null')
os.system('ip netns del nat > /dev/null')
os.system('ip netns add R > /dev/null')
os.system('ip netns add LA > /dev/null')
os.system('ip netns add RA > /dev/null')
os.system('ip netns add c1 > /dev/null')
os.system('ip netns add m1 > /dev/null')
os.system('ip netns add m2 > /dev/null')
os.system('ip netns add s1 > /dev/null')
os.system('ip netns add nat > /dev/null')
os.system('echo 1 > /proc/sys/net/ipv4/ip_forward')

#Control interfaces
LA_c::DyscoVPort(ifname='LA-c', netns='/var/run/netns/LA', mac_addr='00:00:00:00:ff:01', ip_addrs=['172.16.0.1/16'])
m1_c::DyscoVPort(ifname='m1-c', netns='/var/run/netns/m1', mac_addr='00:00:00:00:ff:02', ip_addrs=['172.16.0.2/16'])
c1_c::DyscoVPort(ifname='c1-c', netns='/var/run/netns/c1', mac_addr='00:00:00:00:ff:03', ip_addrs=['172.16.0.3/16'])
RA_c::DyscoVPort(ifname='RA-c', netns='/var/run/netns/RA', mac_addr='00:00:00:00:ff:04', ip_addrs=['172.16.0.4/16'])

LA_1::DyscoVPort(ifname='LA-1', netns='/var/run/netns/LA', mac_addr='00:00:00:00:00:32', ip_addrs=['10.0.3.2/24'])
RA_1::DyscoVPort(ifname='RA-1', netns='/var/run/netns/RA', mac_addr='00:00:00:00:00:42', ip_addrs=['10.0.4.2/24'])
m1_0::DyscoVPort(ifname='m1-0', netns='/var/run/netns/m1', mac_addr='00:00:00:00:00:52', ip_addrs=['10.0.5.2/24'])
m1_1::DyscoVPort(ifname='m1-1', netns='/var/run/netns/m1', mac_addr='00:00:00:00:00:62', ip_addrs=['10.0.6.2/24'])
m2_0::DyscoVPort(ifname='m2-0', netns='/var/run/netns/m2', mac_addr='00:00:00:00:00:72', ip_addrs=['10.0.7.2/24'])
m2_1::DyscoVPort(ifname='m2-1', netns='/var/run/netns/m2', mac_addr='00:00:00:00:00:82', ip_addrs=['10.0.8.2/24'])

c1_0::DyscoVPort(ifname='c1-0', netns='/var/run/netns/c1', mac_addr='00:00:00:00:00:12', ip_addrs=['10.0.1.2/24'])
nat_0::DyscoVPort(ifname='nat-0', netns='/var/run/netns/nat', mac_addr='00:00:00:00:00:01', ip_addrs=['10.0.0.1/24'])
nat_1::DyscoVPort(ifname='nat-1', netns='/var/run/netns/nat', mac_addr='00:00:00:00:00:22', ip_addrs=['10.0.2.2/24'])
s1_0::DyscoVPort(ifname='s1-0', netns='/var/run/netns/s1', mac_addr='00:00:00:00:00:02', ip_addrs=['10.0.0.2/24'])
LA_0::DyscoVPort(ifname='LA-0', netns='/var/run/netns/LA', mac_addr='00:00:00:00:00:11', ip_addrs=['10.0.1.1/24'])
RA_0::DyscoVPort(ifname='RA-0', netns='/var/run/netns/RA', mac_addr='00:00:00:00:00:21', ip_addrs=['10.0.2.1/24'])

R_1::DyscoVPort(ifname='R-1', netns='/var/run/netns/R', mac_addr='00:00:00:00:00:31', ip_addrs=['10.0.3.1/24'])
R_2::DyscoVPort(ifname='R-2', netns='/var/run/netns/R', mac_addr='00:00:00:00:00:41', ip_addrs=['10.0.4.1/24'])
R_3::DyscoVPort(ifname='R-3', netns='/var/run/netns/R', mac_addr='00:00:00:00:00:51', ip_addrs=['10.0.5.1/24'])
R_4::DyscoVPort(ifname='R-4', netns='/var/run/netns/R', mac_addr='00:00:00:00:00:61', ip_addrs=['10.0.6.1/24'])
R_5::DyscoVPort(ifname='R-5', netns='/var/run/netns/R', mac_addr='00:00:00:00:00:71', ip_addrs=['10.0.7.1/24'])
R_6::DyscoVPort(ifname='R-6', netns='/var/run/netns/R', mac_addr='00:00:00:00:00:81', ip_addrs=['10.0.8.1/24'])

os.system('ip netns exec LA ifconfig lo up > /dev/null')
os.system('ip netns exec RA ifconfig lo up > /dev/null')
os.system('ip netns exec c1 ifconfig lo up > /dev/null')
os.system('ip netns exec s1 ifconfig lo up > /dev/null')
os.system('ip netns exec m1 ifconfig lo up > /dev/null')
os.system('ip netns exec m2 ifconfig lo up > /dev/null')
os.system('ip netns exec R ifconfig lo up > /dev/null')
os.system('ip netns exec nat ifconfig lo up > /dev/null')

os.system('ip netns exec c1 route add default gw 10.0.1.1 > /dev/null')
os.system('ip netns exec s1 route add default gw 10.0.0.1 > /dev/null')
os.system('ip netns exec LA route add default gw 10.0.3.1 > /dev/null')
os.system('ip netns exec RA route add default gw 10.0.4.1 > /dev/null')
os.system('ip netns exec RA route add -net 10.0.0.0/24 gw 10.0.2.2 > /dev/null')
os.system('ip netns exec m1 route add -net 10.0.1.0/24 gw 10.0.5.1 > /dev/null')
os.system('ip netns exec m1 route add default gw 10.0.6.1 > /dev/null')
os.system('ip netns exec m2 route add -net 10.0.1.0/24 gw 10.0.7.1 > /dev/null')
os.system('ip netns exec m2 route add default gw 10.0.8.1 > /dev/null')

os.system('ip netns exec nat route add default gw 10.0.2.1 > /dev/null')
os.system('ip netns exec nat iptables -t nat -A POSTROUTING -o nat-1 -j MASQUERADE > /dev/null')
os.system('ip netns exec nat iptables -t filter -A FORWARD -i nat-0 -j ACCEPT > /dev/null')

l2_c::L2FWD()
l2_c.add(mac_addr='00:00:00:00:ff:01', gate=0)
l2_c.add(mac_addr='00:00:00:00:ff:02', gate=1)
l2_c.add(mac_addr='00:00:00:00:ff:03', gate=2)
l2_c.add(mac_addr='00:00:00:00:ff:04', gate=3)

PortInc(port=LA_c) -> l2_c
PortInc(port=m1_c) -> l2_c
PortInc(port=c1_c) -> l2_c
PortInc(port=RA_c) -> l2_c
l2_c:0 -> PortOut(port=LA_c)
l2_c:1 -> PortOut(port=m1_c)
l2_c:2 -> PortOut(port=c1_c)
l2_c:3 -> PortOut(port=RA_c)

dc::DyscoCenter()

l2_0::L2FWD()
l2_0.add(mac_addr='00:00:00:00:00:01', gate=0)
l2_0.add(mac_addr='00:00:00:00:00:02', gate=1)
l2_1::L2FWD()
l2_1.add(mac_addr='00:00:00:00:00:11', gate=0)
l2_1.add(mac_addr='00:00:00:00:00:12', gate=1)
l2_2::L2FWD()
l2_2.add(mac_addr='00:00:00:00:00:21', gate=0)
l2_2.add(mac_addr='00:00:00:00:00:22', gate=1)
l2_3::L2FWD()
l2_3.add(mac_addr='00:00:00:00:00:31', gate=0)
l2_3.add(mac_addr='00:00:00:00:00:32', gate=1)
l2_4::L2FWD()
l2_4.add(mac_addr='00:00:00:00:00:41', gate=0)
l2_4.add(mac_addr='00:00:00:00:00:42', gate=1)
l2_5::L2FWD()
l2_5.add(mac_addr='00:00:00:00:00:51', gate=0)
l2_5.add(mac_addr='00:00:00:00:00:52', gate=1)
l2_6::L2FWD()
l2_6.add(mac_addr='00:00:00:00:00:61', gate=0)
l2_6.add(mac_addr='00:00:00:00:00:62', gate=1)
l2_7::L2FWD()
l2_7.add(mac_addr='00:00:00:00:00:71', gate=0)
l2_7.add(mac_addr='00:00:00:00:00:72', gate=1)
l2_8::L2FWD()
l2_8.add(mac_addr='00:00:00:00:00:81', gate=0)
l2_8.add(mac_addr='00:00:00:00:00:82', gate=1)

din1::DyscoAgentIn(dc=dc) -> DyscoPortOut(port=c1_0)
din2::DyscoAgentIn(dc=dc) -> DyscoPortOut(port=s1_0)
din3::DyscoAgentIn(dc=dc) -> DyscoPortOut(port=LA_0)
din4::DyscoAgentIn(dc=dc) -> DyscoPortOut(port=RA_0)
din5::DyscoAgentIn(dc=dc) -> DyscoPortOut(port=LA_1)
din6::DyscoAgentIn(dc=dc) -> DyscoPortOut(port=RA_1)
din7::DyscoAgentIn(dc=dc) -> DyscoPortOut(port=m1_0)
din8::DyscoAgentIn(dc=dc) -> DyscoPortOut(port=m1_1)
din9::DyscoAgentIn(dc=dc) -> DyscoPortOut(port=m2_0)
din10::DyscoAgentIn(dc=dc) -> DyscoPortOut(port=m2_1)

DyscoPortInc(port=c1_0) -> dout1::DyscoAgentOut(dc=dc)
DyscoPortInc(port=s1_0) -> dout2::DyscoAgentOut(dc=dc)
DyscoPortInc(port=LA_0) -> dout3::DyscoAgentOut(dc=dc)
DyscoPortInc(port=RA_0) -> dout4::DyscoAgentOut(dc=dc)
DyscoPortInc(port=LA_1) -> dout5::DyscoAgentOut(dc=dc)
DyscoPortInc(port=RA_1) -> dout6::DyscoAgentOut(dc=dc)
DyscoPortInc(port=m1_0) -> dout7::DyscoAgentOut(dc=dc)
DyscoPortInc(port=m1_1) -> dout8::DyscoAgentOut(dc=dc)
DyscoPortInc(port=m2_0) -> dout9::DyscoAgentOut(dc=dc)
DyscoPortInc(port=m2_1) -> dout10::DyscoAgentOut(dc=dc)

din1.setup()
din2.setup()
din3.setup()
din4.setup()
din5.setup()
din6.setup()
din7.setup()
din8.setup()
din9.setup()
din10.setup()
dout1.setup()
dout2.setup()
dout3.setup()
dout4.setup()
dout5.setup()
dout6.setup()
dout7.setup()
dout8.setup()
dout9.setup()
dout10.setup()

dout2 -> l2_0
PortInc(port=nat_0) -> l2_0
dout1 -> l2_1
dout3 -> l2_1
dout4 -> l2_2
PortInc(port=nat_1) -> l2_2
dout5 -> l2_3
PortInc(port=R_1) -> l2_3
dout6 -> l2_4
PortInc(port=R_2) -> l2_4
dout7 -> l2_5
PortInc(port=R_3) -> l2_5
dout8 -> l2_6
PortInc(port=R_4) -> l2_6
dout9 -> l2_7
PortInc(port=R_5) -> l2_7
dout10 -> l2_8
PortInc(port=R_6) -> l2_8

din1:1 -> l2_1
dout1:1 -> l2_1
din3:1 -> l2_1
dout3:1 -> l2_1
din2:1 -> l2_0
dout2:1 -> l2_0
din4:1 -> l2_2
dout4:1 -> l2_2
din5:1 -> l2_3
dout5:1 -> l2_3
din6:1 -> l2_4
dout6:1 -> l2_4
din7:1 -> l2_5
dout7:1 -> l2_5
din8:1 -> l2_6
dout8:1 -> l2_6
din9:1 -> l2_7
dout9:1 -> l2_7
din10:1 -> l2_8
dout10:1 -> l2_8

l2_0:0 -> PortOut(port=nat_0)
l2_0:1 -> din2
l2_1:0 -> din3
l2_1:1 -> din1
l2_2:0 -> din4
l2_2:1 -> PortOut(port=nat_1)
l2_3:0 -> PortOut(port=R_1)
l2_3:1 -> din5
l2_4:0 -> PortOut(port=R_2)
l2_4:1 -> din6
l2_5:0 -> PortOut(port=R_3)
l2_5:1 -> din7
l2_6:0 -> PortOut(port=R_4)
l2_6:1 -> din8
l2_7:0 -> PortOut(port=R_5)
l2_7:1 -> din9
l2_8:0 -> PortOut(port=R_6)
l2_8:1 -> din10

dc.add(priority=1, sc_len=4, chain=['10.0.1.1', '10.0.5.2', '10.0.4.2', '10.0.0.2'], filter='dst port 5001', ns='/var/run/netns/c1')
#dc.add(priority=1, sc_len=3, chain=['10.0.5.2', '10.0.4.2', '10.0.0.2'], filter='dst port 5001', ns='/var/run/netns/LA')

dc.add(priority=1, sc_len=2, chain=['10.0.4.2', '10.0.0.2'], filter='dst port 5001', ns='/var/run/netns/m1')

os.system('ip netns exec c1 tcpdump -i c1-0 arp or icmp or tcp -n -XX -w /home/fabricio/c1_0.pcap & 2> /dev/null')
os.system('ip netns exec s1 tcpdump -i s1-0 arp or icmp or tcp -n -XX -w /home/fabricio/s1_0.pcap & 2> /dev/null')
os.system('ip netns exec m1 tcpdump -i m1-0 arp or icmp or tcp -n -XX -w /home/fabricio/m1_0.pcap & 2> /dev/null')
os.system('ip netns exec m1 tcpdump -i m1-1 arp or icmp or tcp -n -XX -w /home/fabricio/m1_1.pcap & 2> /dev/null')
os.system('ip netns exec m2 tcpdump -i m2-0 arp or icmp or tcp -n -XX -w /home/fabricio/m2_0.pcap & 2> /dev/null')
os.system('ip netns exec m2 tcpdump -i m2-1 arp or icmp or tcp -n -XX -w /home/fabricio/m2_1.pcap & 2> /dev/null')