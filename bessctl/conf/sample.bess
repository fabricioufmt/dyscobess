import os
import scapy.all as scapy

os.system('ip netns del c1 > /dev/null')
os.system('ip netns del mb1 > /dev/null')
os.system('ip netns del mb2 > /dev/null')
os.system('ip netns del mb3 > /dev/null')
os.system('ip netns del mb4 > /dev/null')
os.system('ip netns del s1 > /dev/null')
os.system('ip netns add c1 > /dev/null')
os.system('ip netns add mb1 > /dev/null')
os.system('ip netns add mb2 > /dev/null')
os.system('ip netns add mb3 > /dev/null')
os.system('ip netns add mb4 > /dev/null')
os.system('ip netns add s1 > /dev/null')
os.system('echo 1 > /proc/sys/net/ipv4/ip_forward')

c1::DyscoVPort(ifname='c1-0', netns='/var/run/netns/c1', mac_addr='00:00:00:00:00:11', ip_addrs=['10.0.1.1/24'])
mb1_0::DyscoVPort(ifname='mb1-0', netns='/var/run/netns/mb1', mac_addr='00:00:00:00:00:12', ip_addrs=['10.0.1.2/24'])
mb1_1::DyscoVPort(ifname='mb1-1', netns='/var/run/netns/mb1', mac_addr='00:00:00:00:00:21', ip_addrs=['10.0.2.1/24'])
mb2_0::DyscoVPort(ifname='mb2-0', netns='/var/run/netns/mb2', mac_addr='00:00:00:00:00:22', ip_addrs=['10.0.2.2/24'])
mb2_1::DyscoVPort(ifname='mb2-1', netns='/var/run/netns/mb2', mac_addr='00:00:00:00:00:32', ip_addrs=['10.0.3.2/24'])
mb3_0::DyscoVPort(ifname='mb3-0', netns='/var/run/netns/mb3', mac_addr='00:00:00:00:00:23', ip_addrs=['10.0.2.3/24'])
mb3_1::DyscoVPort(ifname='mb3-1', netns='/var/run/netns/mb3', mac_addr='00:00:00:00:00:33', ip_addrs=['10.0.3.3/24'])
mb4_0::DyscoVPort(ifname='mb4-0', netns='/var/run/netns/mb4', mac_addr='00:00:00:00:00:31', ip_addrs=['10.0.3.1/24'])
mb4_1::DyscoVPort(ifname='mb4-1', netns='/var/run/netns/mb4', mac_addr='00:00:00:00:00:42', ip_addrs=['10.0.4.2/24'])
s1::DyscoVPort(ifname='s1-0', netns='/var/run/netns/s1', mac_addr='00:00:00:00:00:41', ip_addrs=['10.0.4.1/24'])

os.system('ip netns exec c1 ifconfig lo up > /dev/null')
os.system('ip netns exec mb1 ifconfig lo up > /dev/null')
os.system('ip netns exec mb2 ifconfig lo up > /dev/null')
os.system('ip netns exec mb3 ifconfig lo up > /dev/null')
os.system('ip netns exec mb4 ifconfig lo up > /dev/null')
os.system('ip netns exec s1 ifconfig lo up > /dev/null')

os.system('ip netns exec c1 route add default gw 10.0.1.2 > /dev/null')
os.system('ip netns exec s1 route add default gw 10.0.4.2 > /dev/null')
os.system('ip netns exec mb2 route add -net 10.0.1.0/24 gw 10.0.2.1 > /dev/null')
os.system('ip netns exec mb2 route add default gw 10.0.3.1 > /dev/null')
os.system('ip netns exec mb3 route add -net 10.0.1.0/24 gw 10.0.2.1 > /dev/null')
os.system('ip netns exec mb3 route add default gw 10.0.3.1 > /dev/null')

#TODO: ask to Ronaldo about these routes
os.system('ip netns exec mb1 route add default gw 10.0.2.2 > /dev/null')
os.system('ip netns exec mb4 route add default gw 10.0.3.2 > /dev/null')

#os.system('ip netns exec c1 arp -s 10.0.1.2 00:00:00:00:00:12 > /dev/null')
#os.system('ip netns exec s1 arp -s 10.0.4.2 00:00:00:00:00:42 > /dev/null')

#os.system('ip netns exec mb1 arp -s 10.0.1.1 00:00:00:00:00:11 > /dev/null')
#os.system('ip netns exec mb1 arp -s 10.0.2.2 00:00:00:00:00:22 > /dev/null')
#os.system('ip netns exec mb1 arp -s 10.0.2.3 00:00:00:00:00:23 > /dev/null')
#os.system('ip netns exec mb2 arp -s 10.0.2.1 00:00:00:00:00:21 > /dev/null')
#os.system('ip netns exec mb2 arp -s 10.0.3.1 00:00:00:00:00:31 > /dev/null')
#os.system('ip netns exec mb3 arp -s 10.0.2.1 00:00:00:00:00:21 > /dev/null')
#os.system('ip netns exec mb3 arp -s 10.0.3.1 00:00:00:00:00:31 > /dev/null')
#os.system('ip netns exec mb4 arp -s 10.0.4.1 00:00:00:00:00:41 > /dev/null')
#os.system('ip netns exec mb4 arp -s 10.0.3.2 00:00:00:00:00:32 > /dev/null')
#os.system('ip netns exec mb4 arp -s 10.0.3.3 00:00:00:00:00:33 > /dev/null')

dc::DyscoCenter()

fib::L2Forward()
fib.add(entries=[
	{'addr':'00:00:00:00:00:11', 'gate':0},
	{'addr':'00:00:00:00:00:12', 'gate':1},
	{'addr':'00:00:00:00:00:21', 'gate':2},
	{'addr':'00:00:00:00:00:22', 'gate':3},
	{'addr':'00:00:00:00:00:23', 'gate':4},
	{'addr':'00:00:00:00:00:31', 'gate':5},
	{'addr':'00:00:00:00:00:32', 'gate':6},
	{'addr':'00:00:00:00:00:33', 'gate':7},
	{'addr':'00:00:00:00:00:41', 'gate':8},
	{'addr':'00:00:00:00:00:42', 'gate':9},
	{'addr':'ff:ff:ff:ff:ff:ff', 'gate':10},
	])	
					    

#ipl::IPLookup()
#ipl.add(prefix='10.0.1.1', prefix_len=32, gate=0)
#ipl.add(prefix='10.0.1.2', prefix_len=32, gate=1)
#ipl.add(prefix='10.0.2.1', prefix_len=32, gate=2)
#ipl.add(prefix='10.0.2.2', prefix_len=32, gate=3)
#ipl.add(prefix='10.0.2.3', prefix_len=32, gate=4)
#ipl.add(prefix='10.0.3.1', prefix_len=32, gate=5)
#ipl.add(prefix='10.0.3.2', prefix_len=32, gate=6)
#ipl.add(prefix='10.0.3.3', prefix_len=32, gate=7)
#ipl.add(prefix='10.0.4.1', prefix_len=32, gate=8)
#ipl.add(prefix='10.0.4.2', prefix_len=32, gate=9)

DyscoPortInc(port=c1) -> DyscoAgentOut(dc=dc) -> fib #ipl
DyscoPortInc(port=mb1_0) -> DyscoAgentOut(dc=dc) -> fib #ipl
DyscoPortInc(port=mb1_1) -> DyscoAgentOut(dc=dc) -> fib #ipl
DyscoPortInc(port=mb2_0) -> DyscoAgentOut(dc=dc) -> fib #ipl
DyscoPortInc(port=mb2_1) -> DyscoAgentOut(dc=dc) -> fib #ipl
DyscoPortInc(port=mb3_0) -> DyscoAgentOut(dc=dc) -> fib #ipl
DyscoPortInc(port=mb3_1) -> DyscoAgentOut(dc=dc) -> fib #ipl
DyscoPortInc(port=mb4_0) -> DyscoAgentOut(dc=dc) -> fib #ipl
DyscoPortInc(port=mb4_1) -> DyscoAgentOut(dc=dc) -> fib #ipl
DyscoPortInc(port=s1) -> DyscoAgentOut(dc=dc) -> fib #ipl

#ipl:0 -> Update(fields=[{'offset':0, 'size':6, 'value':17}]) -> DyscoPortOut(port=c1)
#ipl:1 -> Update(fields=[{'offset':0, 'size':6, 'value':18}]) -> DyscoPortOut(port=mb1_0)
#ipl:2 -> Update(fields=[{'offset':0, 'size':6, 'value':33}]) -> DyscoPortOut(port=mb1_1)
#ipl:3 -> Update(fields=[{'offset':0, 'size':6, 'value':34}]) -> DyscoPortOut(port=mb2_0)
#ipl:4 -> Update(fields=[{'offset':0, 'size':6, 'value':35}]) -> DyscoPortOut(port=mb2_1)
#ipl:5 -> Update(fields=[{'offset':0, 'size':6, 'value':49}]) -> DyscoPortOut(port=mb3_0)
#ipl:6 -> Update(fields=[{'offset':0, 'size':6, 'value':50}]) -> DyscoPortOut(port=mb3_1)
#ipl:7 -> Update(fields=[{'offset':0, 'size':6, 'value':51}]) -> DyscoPortOut(port=mb4_0)
#ipl:8 -> Update(fields=[{'offset':0, 'size':6, 'value':65}]) -> DyscoPortOut(port=s1)
#ipl:9 -> Update(fields=[{'offset':0, 'size':6, 'value':66}]) -> DyscoPortOut(port=mb4_1)

da0::DyscoPortOut(port=c1)
da1::DyscoPortOut(port=mb1_0)
da2::DyscoPortOut(port=mb1_1)
da3::DyscoPortOut(port=mb2_0)
da4::DyscoPortOut(port=mb3_0)
da5::DyscoPortOut(port=mb4_0)
da6::DyscoPortOut(port=mb2_1)
da7::DyscoPortOut(port=mb3_1)
da9::DyscoPortOut(port=mb4_1)
da8::DyscoPortOut(port=s1)

#da0::DyscoAgentIn(dc=dc) -> DyscoPortOut(port=c1)
#da1::DyscoAgentIn(dc=dc) -> DyscoPortOut(port=mb1_0)
#da2::DyscoAgentIn(dc=dc) -> DyscoPortOut(port=mb1_1)
#da3::DyscoAgentIn(dc=dc) -> DyscoPortOut(port=mb2_0)
#da4::DyscoAgentIn(dc=dc) -> DyscoPortOut(port=mb3_0)
#da5::DyscoAgentIn(dc=dc) -> DyscoPortOut(port=mb4_0)
#da6::DyscoAgentIn(dc=dc) -> DyscoPortOut(port=mb2_1)
#da7::DyscoAgentIn(dc=dc) -> DyscoPortOut(port=mb3_1)
#da9::DyscoAgentIn(dc=dc) -> DyscoPortOut(port=mb4_1)
#da8::DyscoAgentIn(dc=dc) -> DyscoPortOut(port=s1)

fib:0 -> da0
fib:1 -> da1
fib:2 -> da2
fib:3 -> da3
fib:4 -> da4
fib:5 -> da5
fib:6 -> da6
fib:7 -> da7
fib:9 -> da9
fib:8 -> da8

fib:10 -> repl::Replicate(gates=[0,1,2,3,4,5,6,7,8,9])

repl:0 -> da0
repl:1 -> da1
repl:2 -> da2
repl:3 -> da3
repl:4 -> da4
repl:5 -> da5
repl:6 -> da6
repl:7 -> da7
repl:9 -> da9
repl:8 -> da8

os.system('ip netns exec c1 tcpdump -i c1-0 tcp or arp -n -XX -w /home/fabricio/c1.pcap & > /dev/null')
os.system('ip netns exec s1 tcpdump -i s1-0 tcp or arp -n -XX -w /home/fabricio/s1.pcap & > /dev/null')
os.system('ip netns exec mb1 tcpdump -i mb1-0 tcp or arp -n -XX -w /home/fabricio/mb1_0.pcap & > /dev/null')
os.system('ip netns exec mb1 tcpdump -i mb1-1 tcp or arp -n -XX -w /home/fabricio/mb1_1.pcap & > /dev/null')
os.system('ip netns exec mb2 tcpdump -i mb2-0 tcp or arp -n -XX -w /home/fabricio/mb2_0.pcap & > /dev/null')
os.system('ip netns exec mb2 tcpdump -i mb2-1 tcp or arp -n -XX -w /home/fabricio/mb2_1.pcap & > /dev/null')
os.system('ip netns exec mb3 tcpdump -i mb3-0 tcp or arp -n -XX -w /home/fabricio/mb3_0.pcap & > /dev/null')
os.system('ip netns exec mb3 tcpdump -i mb3-1 tcp or arp -n -XX -w /home/fabricio/mb3_1.pcap & > /dev/null')
os.system('ip netns exec mb4 tcpdump -i mb4-0 tcp or arp -n -XX -w /home/fabricio/mb4_0.pcap & > /dev/null')
os.system('ip netns exec mb4 tcpdump -i mb4-1 tcp or arp -n -XX -w /home/fabricio/mb4_1.pcap & > /dev/null')