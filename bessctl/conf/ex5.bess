import os
import scapy.all as scapy

os.system('ip netns del c1 > /dev/null')
os.system('ip netns del m1 > /dev/null')
os.system('ip netns del m2 > /dev/null')
os.system('ip netns del m3 > /dev/null')
os.system('ip netns del m4 > /dev/null')
os.system('ip netns del s1 > /dev/null')
os.system('ip netns add c1 > /dev/null')
os.system('ip netns add m1 > /dev/null')
os.system('ip netns add m2 > /dev/null')
os.system('ip netns add m3 > /dev/null')
os.system('ip netns add m4 > /dev/null')
os.system('ip netns add s1 > /dev/null')
os.system('echo 1 > /proc/sys/net/ipv4/ip_forward')

c1::DyscoVPort(ifname='c1-0', netns='/var/run/netns/c1', mac_addr='00:00:00:00:00:11', ip_addrs=['10.0.1.1/24'])
m1_0::DyscoVPort(ifname='m1-0', netns='/var/run/netns/m1', mac_addr='00:00:00:00:00:12', ip_addrs=['10.0.1.2/24'])
m1_1::DyscoVPort(ifname='m1-1', netns='/var/run/netns/m1', mac_addr='00:00:00:00:00:21', ip_addrs=['10.0.2.1/24'])
m2_0::DyscoVPort(ifname='m2-0', netns='/var/run/netns/m2', mac_addr='00:00:00:00:00:22', ip_addrs=['10.0.2.2/24'])
m3_0::DyscoVPort(ifname='m3-0', netns='/var/run/netns/m3', mac_addr='00:00:00:00:00:23', ip_addrs=['10.0.2.3/24'])
m4_0::DyscoVPort(ifname='m4-0', netns='/var/run/netns/m4', mac_addr='00:00:00:00:00:31', ip_addrs=['10.0.3.1/24'])
m2_1::DyscoVPort(ifname='m2-1', netns='/var/run/netns/m2', mac_addr='00:00:00:00:00:32', ip_addrs=['10.0.3.2/24'])
m3_1::DyscoVPort(ifname='m3-1', netns='/var/run/netns/m3', mac_addr='00:00:00:00:00:33', ip_addrs=['10.0.3.3/24']) 
s1::DyscoVPort(ifname='s1-0', netns='/var/run/netns/s1', mac_addr='00:00:00:00:00:41', ip_addrs=['10.0.4.1/24'])
m4_1::DyscoVPort(ifname='m4-1', netns='/var/run/netns/m4', mac_addr='00:00:00:00:00:42', ip_addrs=['10.0.4.2/24'])

os.system('ip netns exec c1 ifconfig lo up > /dev/null')
os.system('ip netns exec m1 ifconfig lo up > /dev/null')
os.system('ip netns exec m2 ifconfig lo up > /dev/null')
os.system('ip netns exec m3 ifconfig lo up > /dev/null')
os.system('ip netns exec m4 ifconfig lo up > /dev/null')
os.system('ip netns exec s1 ifconfig lo up > /dev/null')

os.system('ip netns exec c1 route add default gw 10.0.1.2 > /dev/null')
os.system('ip netns exec s1 route add default gw 10.0.4.2 > /dev/null')
os.system('ip netns exec m1 route add default gw 10.0.2.2 > /dev/null')
os.system('ip netns exec m2 route add -net 10.0.1.0/24 gw 10.0.2.1 > /dev/null')
os.system('ip netns exec m2 route add default gw 10.0.3.1 > /dev/null')
os.system('ip netns exec m3 route add -net 10.0.1.0/24 gw 10.0.2.1 > /dev/null')
os.system('ip netns exec m3 route add default gw 10.0.3.1 > /dev/null')
os.system('ip netns exec m4 route add default gw 10.0.3.2 > /dev/null')

ipl::IPLookup()
ipl.add(prefix='10.0.1.1', prefix_len=32, gate=0)
ipl.add(prefix='10.0.1.2', prefix_len=32, gate=1)
ipl.add(prefix='10.0.2.1', prefix_len=32, gate=2)
ipl.add(prefix='10.0.2.2', prefix_len=32, gate=3)
ipl.add(prefix='10.0.2.3', prefix_len=32, gate=4)
ipl.add(prefix='10.0.3.1', prefix_len=32, gate=5)
ipl.add(prefix='10.0.3.2', prefix_len=32, gate=6)
ipl.add(prefix='10.0.3.3', prefix_len=32, gate=7)
ipl.add(prefix='10.0.4.1', prefix_len=32, gate=8)
ipl.add(prefix='10.0.4.2', prefix_len=32, gate=9)

dc::DyscoCenter()

DyscoPortInc(port=c1) -> DyscoAgentOut(dc=dc) -> ipl
DyscoPortInc(port=m1_0) -> DyscoAgentOut(dc=dc) -> ipl
DyscoPortInc(port=m1_1) -> DyscoAgentOut(dc=dc) -> ipl
DyscoPortInc(port=m2_0) -> DyscoAgentOut(dc=dc) -> ipl
DyscoPortInc(port=m2_1) -> DyscoAgentOut(dc=dc) -> ipl
DyscoPortInc(port=m3_0) -> DyscoAgentOut(dc=dc) -> ipl
DyscoPortInc(port=m3_1) -> DyscoAgentOut(dc=dc) -> ipl
DyscoPortInc(port=m4_0) -> DyscoAgentOut(dc=dc) -> ipl
DyscoPortInc(port=m4_1) -> DyscoAgentOut(dc=dc) -> ipl
DyscoPortInc(port=s1) -> DyscoAgentOut(dc=dc) -> ipl

ipl:0 -> Update(fields=[{'offset':0, 'size':6, 'value':17}]) -> DyscoAgentIn(dc=dc) -> DyscoPortOut(port=c1)
ipl:1 -> Update(fields=[{'offset':0, 'size':6, 'value':18}]) -> DyscoAgentIn(dc=dc) -> DyscoPortOut(port=m1_0)
ipl:2 -> Update(fields=[{'offset':0, 'size':6, 'value':33}]) -> DyscoAgentIn(dc=dc) -> DyscoPortOut(port=m1_1)
ipl:3 -> Update(fields=[{'offset':0, 'size':6, 'value':34}]) -> DyscoAgentIn(dc=dc) -> DyscoPortOut(port=m2_0)
ipl:4 -> Update(fields=[{'offset':0, 'size':6, 'value':35}]) -> DyscoAgentIn(dc=dc) -> DyscoPortOut(port=m2_1)
ipl:5 -> Update(fields=[{'offset':0, 'size':6, 'value':49}]) -> DyscoAgentIn(dc=dc) -> DyscoPortOut(port=m3_0)
ipl:6 -> Update(fields=[{'offset':0, 'size':6, 'value':50}]) -> DyscoAgentIn(dc=dc) -> DyscoPortOut(port=m3_1)
ipl:7 -> Update(fields=[{'offset':0, 'size':6, 'value':51}]) -> DyscoAgentIn(dc=dc) -> DyscoPortOut(port=m4_0)
ipl:8 -> Update(fields=[{'offset':0, 'size':6, 'value':65}]) -> DyscoAgentIn(dc=dc) -> DyscoPortOut(port=s1)
ipl:9 -> Update(fields=[{'offset':0, 'size':6, 'value':66}]) -> DyscoAgentIn(dc=dc) -> DyscoPortOut(port=m4_1)

dc.add(priority=1, sc_len=3, chain=['10.0.2.2', '10.0.3.1', '10.0.4.1'], filter='dst port 5001', ns='/var/run/netns/m1')
dc.add(priority=2, sc_len=3, chain=['10.0.2.3', '10.0.3.1', '10.0.4.1'], filter='dst port 5002', ns='/var/run/netns/m1')
dc.add(priority=3, sc_len=3, chain=['10.0.3.1', '10.0.4.1'], filter='dst port 5003', ns='/var/run/netns/m1')
